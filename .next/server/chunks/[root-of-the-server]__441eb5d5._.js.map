{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///D:/university/project/AstroZangli-AI/AstroZangli-AI/frontend/src/app/api/lunar-festival/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { createRequire } from \"module\";\r\n\r\n// 使用 createRequire 动态创建 require 函数，避免构建时解析问题\r\n// 在 Next.js API 路由中，使用当前工作目录\r\nconst require = createRequire(process.cwd() + \"/package.json\");\r\n\r\n// 延迟加载模块，避免构建时解析问题\r\nfunction getLunarCalendar() {\r\n  try {\r\n    // 使用 createRequire 创建的 require 函数加载模块\r\n    // @ts-ignore\r\n    const LunarCalendar = require(\"lunar-calendar\");\r\n    // 处理不同的导出方式\r\n    return LunarCalendar.default || LunarCalendar || LunarCalendar.LunarCalendar;\r\n  } catch (error) {\r\n    console.error(\"无法加载 lunar-calendar 模块:\", error);\r\n    throw new Error(\"无法加载 lunar-calendar 模块\");\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { year, month, day } = await request.json();\r\n\r\n    if (!year || !month || !day) {\r\n      return NextResponse.json(\r\n        { error: \"缺少必要参数\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // 在运行时加载模块\r\n    const calendar = getLunarCalendar();\r\n\r\n    const selectedDate = new Date(year, month - 1, day);\r\n    const currentYear = year;\r\n    const currentMonth = month;\r\n    const currentDay = day;\r\n\r\n    // 最多查找未来2年的数据\r\n    const maxMonths = 24;\r\n    let monthsChecked = 0;\r\n\r\n    // 从当前月份开始查找\r\n    let checkYear = currentYear;\r\n    let checkMonth = currentMonth;\r\n\r\n    while (monthsChecked < maxMonths) {\r\n      try {\r\n        // 获取该月的日历数据\r\n        const monthData = calendar.calendar(checkYear, checkMonth, false);\r\n\r\n        if (monthData && monthData.monthData && Array.isArray(monthData.monthData)) {\r\n          // 遍历该月的每一天\r\n          for (const dateInfo of monthData.monthData) {\r\n            const dateYear = dateInfo.year;\r\n            const dateMonth = dateInfo.month;\r\n            const dateDay = dateInfo.day;\r\n            const solarFestival = dateInfo.solarFestival;\r\n\r\n            // 如果是当前月份，跳过选中日期之前的日期\r\n            if (checkYear === currentYear && checkMonth === currentMonth && dateDay < currentDay) {\r\n              continue;\r\n            }\r\n\r\n            // 检查是否有公历节日\r\n            if (solarFestival && solarFestival.trim() !== \"\") {\r\n              const festivalDate = new Date(dateYear, dateMonth - 1, dateDay);\r\n              // 将时间设置为当天的开始，避免时间比较问题\r\n              festivalDate.setHours(0, 0, 0, 0);\r\n              const selectedDateStart = new Date(selectedDate);\r\n              selectedDateStart.setHours(0, 0, 0, 0);\r\n\r\n              // 只考虑选中日期之后的节日（不包括当天）\r\n              if (festivalDate > selectedDateStart) {\r\n                // 计算剩余天数\r\n                const daysLeft = Math.ceil(\r\n                  (festivalDate.getTime() - selectedDateStart.getTime()) / (1000 * 60 * 60 * 24)\r\n                );\r\n\r\n                // 格式化日期显示\r\n                const dateStr = `${dateMonth}月${dateDay}日`;\r\n\r\n                // 如果同一天有多个节日（用各种分隔符分隔），只取第一个\r\n                // 处理常见分隔符：、，, / | 空格等\r\n                let festivalName = solarFestival.trim();\r\n                // 按各种可能的分隔符分割，取第一个\r\n                const separators = /[、，,/\\|]/;\r\n                if (separators.test(festivalName)) {\r\n                  festivalName = festivalName.split(separators)[0].trim();\r\n                }\r\n                // 如果还有空格分隔的多个节日，也只取第一个\r\n                if (festivalName.includes(' ')) {\r\n                  festivalName = festivalName.split(' ')[0].trim();\r\n                }\r\n\r\n                // 找到第一个符合条件的节日后立即返回，确保只返回最近的第一个节日\r\n                return NextResponse.json({\r\n                  name: festivalName,\r\n                  date: dateStr,\r\n                  daysLeft: daysLeft,\r\n                });\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        // 移动到下一个月\r\n        checkMonth++;\r\n        if (checkMonth > 12) {\r\n          checkMonth = 1;\r\n          checkYear++;\r\n        }\r\n        monthsChecked++;\r\n      } catch (error) {\r\n        // 如果获取数据失败，继续查找下一个月\r\n        checkMonth++;\r\n        if (checkMonth > 12) {\r\n          checkMonth = 1;\r\n          checkYear++;\r\n        }\r\n        monthsChecked++;\r\n      }\r\n    }\r\n\r\n    // 如果2年内都没找到，返回 null\r\n    return NextResponse.json(null);\r\n  } catch (error: any) {\r\n    console.error(\"获取公历节日失败:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"服务器错误\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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","debugId":null}}]
}